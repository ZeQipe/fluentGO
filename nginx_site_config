# FluentGO - основной конфиг для /etc/nginx/sites-available/default
# Проект: голосовой ассистент с WebSocket соединениями
# Backend: FastAPI на порту 8055
# Frontend: Next.js статика в /var/www/fluentgo

# ===================================
# HTTP -> HTTPS редирект
# ===================================
server {
    listen 80;
    listen [::]:80;
    server_name en.workandtravel.com;
    
    # Редирект всего трафика на HTTPS
    return 301 https://$server_name$request_uri;
}

# ===================================
# ОСНОВНОЙ HTTPS СЕРВЕР
# ===================================
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name en.workandtravel.com;
    
    # ===================================
    # SSL НАСТРОЙКИ
    # ===================================
    ssl_certificate /etc/letsencrypt/live/en.workandtravel.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/en.workandtravel.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    
    # ===================================
    # ОБЩИЕ НАСТРОЙКИ
    # ===================================
    client_max_body_size 50M;  # Для загрузки аудио файлов
    
    # Корневая директория со статикой Next.js
    root /var/www/fluentgo;
    index index.html;
    
    # ===================================
    # ЛОГИРОВАНИЕ (опционально)
    # ===================================
    access_log /var/log/nginx/fluentgo.access.log;
    error_log /var/log/nginx/fluentgo.error.log;
    
    # ===================================
    # API ЭНДПОИНТЫ (высший приоритет)
    # ===================================
    location /api/ {
        proxy_pass http://127.0.0.1:8055/api/;
        
        # Основные заголовки
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # CORS и куки
        proxy_set_header Access-Control-Allow-Credentials "true";
        
        # Таймауты для больших файлов
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }
    
    # ===================================
    # WEBSOCKET - VAD Realtime
    # ===================================
    location /ws {
        proxy_pass http://127.0.0.1:8055/ws;
        
        # WebSocket настройки
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Заголовки
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # Таймауты для долгоживущих соединений
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        
        # Отключаем буферизацию для real-time
        proxy_buffering off;
    }
    
    # ===================================
    # WEBSOCKET - Button Realtime
    # ===================================
    location /ws-button {
        proxy_pass http://127.0.0.1:8055/ws-button;
        
        # WebSocket настройки
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Заголовки
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # Таймауты для долгоживущих соединений
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        
        # Отключаем буферизацию для real-time
        proxy_buffering off;
    }
    
    # ===================================
    # NEXT.JS СТАТИЧЕСКИЕ АССЕТЫ
    # ===================================
    
    # Next.js build файлы (агрессивное кеширование)
    location /_next/static/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # Next.js изображения
    location /_next/image/ {
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
    }
    
    # ===================================
    # СТАТИЧЕСКИЕ РЕСУРСЫ ПРОЕКТА
    # ===================================
    
    # Изображения
    location /image/ {
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
        access_log off;
    }
    
    # Файлы локализации
    location /locales/ {
        expires 1d;
        add_header Cache-Control "public, max-age=86400";
    }
    
    # Favicon и прочие файлы в корне
    location = /favicon.ico {
        expires 30d;
        access_log off;
    }
    
    location = /robots.txt {
        expires 1d;
        access_log off;
    }
    
    # SVG и другие статические файлы
    location ~* \.(svg|webp|jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|eot)$ {
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
        access_log off;
    }
    
    # ===================================
    # ПУТЬ /static/* (от FastAPI)
    # ===================================
    # Если FastAPI сам раздает статику через router.mount("/static", ...)
    # раскомментируйте этот блок:
    #
    # location /static/ {
    #     proxy_pass http://127.0.0.1:8055/static/;
    #     proxy_set_header Host $host;
    #     expires 30d;
    #     add_header Cache-Control "public";
    # }
    
    # Или раздавайте напрямую через nginx (более эффективно):
    location /static/ {
        alias /var/www/fluentgo/;
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
    }
    
    # ===================================
    # SPA FALLBACK (всегда последний!)
    # ===================================
    # Все остальные пути возвращают index.html для клиентского роутинга
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # ===================================
    # БЕЗОПАСНОСТЬ
    # ===================================
    # Скрываем версию nginx
    server_tokens off;
    
    # Защита от clickjacking
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    # XSS защита
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Защита от MIME type sniffing
    add_header X-Content-Type-Options "nosniff" always;
    
    # Referrer Policy
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
}

# ===================================
# ДОПОЛНИТЕЛЬНО: Доступ по IP (опционально)
# ===================================
# Если нужен доступ по IP адресу сервера
server {
    listen 80;
    listen [::]:80;
    server_name 91.218.140.211;
    
    # Редирект на основной домен
    return 301 https://en.workandtravel.com$request_uri;
}

# ===================================
# ИНСТРУКЦИЯ ПО УСТАНОВКЕ:
# ===================================
# 1. Скопируйте этот файл в /etc/nginx/sites-available/default:
#    sudo cp nginx_site_config /etc/nginx/sites-available/default
#
# 2. Создайте символическую ссылку (если её нет):
#    sudo ln -sf /etc/nginx/sites-available/default /etc/nginx/sites-enabled/default
#
# 3. Проверьте конфигурацию:
#    sudo nginx -t
#
# 4. Перезагрузите nginx:
#    sudo systemctl reload nginx
#
# 5. Проверьте статус:
#    sudo systemctl status nginx
#
# 6. Убедитесь, что FastAPI запущен на порту 8055:
#    netstat -tlnp | grep 8055
#
# ===================================
# СТРУКТУРА ФАЙЛОВ:
# ===================================
# /var/www/fluentgo/           - корневая директория со статикой
# ├── index.html               - главный HTML файл SPA
# ├── _next/                   - Next.js build файлы
# │   ├── static/              - статические ассеты
# │   └── ...
# ├── image/                   - изображения проекта
# ├── locales/                 - файлы локализации
# │   ├── en/
# │   └── ru/
# ├── favicon.ico
# └── ...
#
# ===================================
# ПРОВЕРКА РАБОТЫ:
# ===================================
# API: curl https://en.workandtravel.com/api/test-db
# WebSocket: wscat -c wss://en.workandtravel.com/ws
# Статика: https://en.workandtravel.com/image/logo.webp
