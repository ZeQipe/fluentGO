(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[359],{12:e=>{e.exports={chatContainer:"ChatContainer_chatContainer__pCqLx",footer_slot:"ChatContainer_footer_slot__pEzeo"}},412:e=>{e.exports={action_buttons:"VoiceMessagesChatUI_action_buttons__APf0G",record_button:"VoiceMessagesChatUI_record_button__bUNNd"}},708:e=>{e.exports={chat_wrapper:"ChatWindow_chat_wrapper__5_GGR",chat_window:"ChatWindow_chat_window__2a6p8",initial_message:"ChatWindow_initial_message__ntJUV",info_message:"ChatWindow_info_message__7yyI_"}},1628:e=>{e.exports={modal:"s_modal__gpWQu"}},1972:(e,t,n)=>{"use strict";n.d(t,{CombinedChatComponent:()=>e_});var r=n(5155),a=n(9780),s=n.n(a),o=n(8049),i=n(2821),l=n(63),c=n(2267),u=n(9244),d=n.n(u),h=n(3782);let m=()=>{let e=(0,l.useSearchParams)().get("mode"),t=(0,l.useRouter)();return(0,h.pD)(),(0,r.jsxs)("div",{className:d().modeSelector,children:[(0,r.jsx)("button",{className:(0,i.A)(d().modeTab,{[d().active]:"realtime"===e}),onClick:()=>t.push(c.J.chatPage.chatPageRealtime),type:"button",children:"Real Time"}),(0,r.jsx)("button",{className:(0,i.A)(d().modeTab,{[d().active]:"voice"===e}),onClick:()=>t.push(c.J.chatPage.chatPageVoice),type:"button",children:"Voice Messages"})]})};var g=n(9815),p=n(2115);let _=e=>{let{url:t,binaryType:n,disabled:r,...a}=e,[s,o]=(0,p.useState)(!1),i=(0,p.useRef)(null),l=function(e){let t=(0,p.useRef)(e);return(0,p.useLayoutEffect)(()=>{t.current=e},[e]),t}(a),c=(0,p.useCallback)(e=>{i.current&&i.current.readyState===WebSocket.OPEN&&i.current.send(e)},[]),u=(0,p.useCallback)(()=>{!r&&(i.current=new WebSocket(t),i.current&&(n&&(i.current.binaryType=n),i.current.onopen=()=>{var e,t;null==(e=(t=l.current).onOpen)||e.call(t),o(!0)},i.current.onmessage=e=>{var t,n;null==(t=(n=l.current).onMessage)||t.call(n,e)},i.current.onclose=()=>{var e,t;null==(e=(t=l.current).onClose)||e.call(t),o(!1)},i.current.onerror=e=>{var t,n;null==(t=(n=l.current).onError)||t.call(n,e),o(!1)}))},[t,n,r]);return(0,p.useEffect)(()=>(u(),()=>{var e;null==(e=i.current)||e.close(),i.current=null}),[u]),{closeConnect:()=>{if(i.current){if(i.current.readyState===WebSocket.OPEN||i.current.readyState===WebSocket.CONNECTING){var e,t;i.current.close(),null==(e=(t=l.current).onClose)||e.call(t)}o(!1)}},send:c,createConnection:u,isActiveConnection:s,wsRef:i}};var C=n(1685),f=n(3203),v=n.n(f),b=n(4627),x=n.n(b);let y=e=>{let{isRecording:t=!1,onClick:n,className:a}=e;return(0,r.jsx)("button",{className:(0,i.A)(x().micButton,{[x().active]:t},a),onClick:n,type:"button",children:"\uD83C\uDFA4"})};var j=n(5548),w=n.n(j),S=n(1479);let U=e=>{let{onClick:t,className:n}=e;return(0,r.jsx)(S.Y,{variant:"danger",as:"button",onClick:t,className:(0,i.A)(w().endButton,n),children:"End"})};var A=n(12),N=n.n(A),E=n(1689),P=n(708),M=n.n(P);let R=e=>{let{initialChatMessage:t,infoMessage:n,messagesNode:a,scrollRef:s,isExpanded:o=!0}=e;return(0,r.jsxs)(E.P.div,{ref:s,className:M().chat_wrapper,initial:{height:"200px"},animate:{height:o?"200px":"0px",opacity:+!!o},transition:{duration:.3,ease:"easeInOut"},style:{overflow:o?"auto":"hidden"},children:[t&&(0,r.jsx)("span",{className:M().initial_message,children:t}),(0,r.jsx)("div",{className:M().chat_window,children:a}),n&&!t&&(0,r.jsx)("p",{className:M().info_message,children:n})]})},k=e=>{let{topSlot:t,footerSlot:n,infoMessage:a,initialChatMessage:s,messagesNode:o,scrollRef:l,className:c,isExpanded:u}=e;return(0,r.jsxs)("div",{className:(0,i.A)(N().chatContainer,c),children:[t,(0,r.jsx)(R,{scrollRef:l,messagesNode:o,infoMessage:a,initialChatMessage:s,isExpanded:u}),!!n&&(0,r.jsx)("div",{className:N().footer_slot,children:n})]})},T=(0,n(7909).default)(()=>Promise.all([n.e(873),n.e(676)]).then(n.bind(n,1676)).then(e=>e.ShowSlotComponent),{loadableGenerated:{webpack:()=>[1676]},ssr:!1});var B=n(5818),I=n(6487),D=n(1628),L=n.n(D);let V=()=>(0,r.jsx)("div",{className:L().modal,children:"Please log in to change settings"}),F=e=>{let t=(0,I.r8)();return(0,r.jsx)(T,{position:"center",mode:t?"click":"hover",slot:t?(0,r.jsx)(B.K,{}):(0,r.jsx)(V,{}),children:(0,r.jsx)(o.CS,{opacity:!t,...e})})};var W=n(4598),H=n.n(W);let O={collapsed:"Expand",expanded:"Collapse"},G=e=>{let{isExpanded:t,onClick:n,className:a}=e;t?O.expanded:O.collapsed;let s=Math.max(O.collapsed.length,O.expanded.length);return(0,r.jsx)(S.Y,{variant:"standart",as:"button",onClick:n,className:(0,i.A)(H().expandButton,a),style:{"--text-length":s},children:t?"Collapse":"Expand"})},J=e=>{let{isRecording:t,isExpanded:n,timer:a,data:s,initChatMessage:o,infoMessage:i,scrollRef:l,endButtonClick:c,handleMicClick:u,expandButtonClick:d,children:h}=e,m=null==s?void 0:s.map((e,t)=>null==h?void 0:h(e,t));return(0,r.jsx)(k,{scrollRef:l,messagesNode:m,infoMessage:i,initialChatMessage:(null==s?void 0:s.length)?"":o,isExpanded:n,topSlot:(0,r.jsxs)("div",{className:v().controls,children:[(0,r.jsxs)("div",{className:v().micSection,children:[(0,r.jsx)(y,{isRecording:t,onClick:u}),(0,r.jsxs)("div",{className:v().statusSection,children:[(0,r.jsx)("div",{className:v().statusText,children:t?"Слушаю... Говорите сейчас":"Начинайте говорить — ассистент слушает"}),(0,r.jsx)("div",{className:v().timer,children:(e=>{let t=Math.floor(e/60);return"".concat(t.toString().padStart(2,"0"),":").concat((e%60).toString().padStart(2,"0"))})(a)})]})]}),(0,r.jsxs)("div",{className:v().actionButtons,children:[(0,r.jsx)(U,{onClick:c}),(0,r.jsx)(G,{isExpanded:n,onClick:d}),(0,r.jsx)(F,{})]})]})})};var z=n(5959),q=n(8270);let Y=(0,z.v)()((0,q.D)(e=>({messages:[],chatStatus:"",isActiveSession:!0,addMessage:t=>{e(e=>{e.messages.push(t)})},setIsActiveSession:t=>{e(e=>{e.isActiveSession=t})},setChatStatus:t=>{e(e=>{e.chatStatus=t})},clearMessagesStore:()=>{e(e=>{e.messages=[],e.chatStatus=""})}}))),K=()=>Y(e=>e.isActiveSession);var Z=n(9675);function Q(){let e=(0,p.useRef)([]),[t,n]=(0,p.useState)(!1),[r,a]=(0,p.useState)(0),s=(0,p.useCallback)(t=>{let r=new DataView(t),s=String.fromCharCode(r.getUint8(0),r.getUint8(1),r.getUint8(2),r.getUint8(3)),o=String.fromCharCode(r.getUint8(8),r.getUint8(9),r.getUint8(10),r.getUint8(11));if("RIFF"!==s||"WAVE"!==o)return void console.warn("Получен не WAV файл или поврежденный заголовок");e.current.push(t),n(!0),a(e.current.length)},[]),o=(0,p.useCallback)(()=>{if(0===e.current.length)return null;try{let t=function(e){if(0===e.length)throw Error("Нет данных для объединения");if(1===e.length)return e[0];let t=function(e){let t=new DataView(e),n=12;for(;n<e.byteLength-8;){let e=String.fromCharCode(t.getUint8(n),t.getUint8(n+1),t.getUint8(n+2),t.getUint8(n+3)),r=t.getUint32(n+4,!0);if("fmt "===e)return{audioFormat:t.getUint16(n+8,!0),channels:t.getUint16(n+10,!0),sampleRate:t.getUint32(n+12,!0),byteRate:t.getUint32(n+16,!0),blockAlign:t.getUint16(n+20,!0),bitsPerSample:t.getUint16(n+22,!0)};n+=8+r}return null}(e[0]);if(!t)throw Error("Не удалось прочитать параметры WAV файла");let n=[],r=0;for(let t of e){let e=function(e){let t=new DataView(e),n=12;for(;n<e.byteLength-8;){let r=String.fromCharCode(t.getUint8(n),t.getUint8(n+1),t.getUint8(n+2),t.getUint8(n+3)),a=t.getUint32(n+4,!0);if("data"===r)return console.log("Извлечено ".concat(a," байт аудио данных")),new Uint8Array(e,n+8,a);if((n+=8+a)>=e.byteLength)break}throw console.error("Структура WAV файла:"),console.error("Первые 50 байт:",new Uint8Array(e.slice(0,50))),Error("Data chunk не найден в WAV файле")}(t);n.push(e),r+=e.length}let a=function(e,t,n,r){let a=new ArrayBuffer(44),s=new DataView(a);return s.setUint8(0,82),s.setUint8(1,73),s.setUint8(2,70),s.setUint8(3,70),s.setUint32(4,36+e,!0),s.setUint8(8,87),s.setUint8(9,65),s.setUint8(10,86),s.setUint8(11,69),s.setUint8(12,102),s.setUint8(13,109),s.setUint8(14,116),s.setUint8(15,32),s.setUint32(16,16,!0),s.setUint16(20,1,!0),s.setUint16(22,n,!0),s.setUint32(24,t,!0),s.setUint32(28,t*n*r/8,!0),s.setUint16(32,n*r/8,!0),s.setUint16(34,r,!0),s.setUint8(36,100),s.setUint8(37,97),s.setUint8(38,116),s.setUint8(39,97),s.setUint32(40,e,!0),new Uint8Array(a)}(r,t.sampleRate,t.channels,t.bitsPerSample),s=new Uint8Array(a.length+r);s.set(a,0);let o=a.length;for(let e of n)s.set(e,o),o+=e.length;return s.buffer}(e.current),r=new Blob([t],{type:"audio/wav"}),s=URL.createObjectURL(r),o=new DataView(t);return String.fromCharCode(o.getUint8(0),o.getUint8(1),o.getUint8(2),o.getUint8(3)),String.fromCharCode(o.getUint8(8),o.getUint8(9),o.getUint8(10),o.getUint8(11)),e.current=[],n(!1),a(0),s}catch(e){return console.error("Ошибка при объединении WAV файлов:",e),null}},[]);return{addChunk:s,finalize:o,reset:(0,p.useCallback)(()=>{e.current=[],n(!1),a(0),console.log("Буфер аудио очищен")},[]),hasChunks:t,chunksCount:r}}let $=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3,[t,n]=(0,p.useState)("no audio"),r=(0,p.useRef)(null),a=(0,p.useRef)(!0);return{onAudioChunk:(0,p.useCallback)(()=>{a.current&&(n("start sending audio"),a.current=!1),r.current&&clearTimeout(r.current),r.current=setTimeout(()=>{n("end sending audio"),a.current=!0},e)},[e]),audioStatus:t}},X={VOICE_DETECTED:"Voice detected. Clearing playback queue.",USER_TIMES_REMAINING:"<b>Minutes remaining:</b>"},ee=(0,z.v)((e,t)=>({lastPlayedAudioId:null,setLastPlayedAudioId:t=>{e({lastPlayedAudioId:t})},clearLastPlayedAudioId:()=>{e({lastPlayedAudioId:null})},isAudioAlreadyPlayed:e=>{let{lastPlayedAudioId:n}=t();return n===e}})),et=(0,z.v)()((0,q.D)(e=>({isRecording:!1,timer:0,setIsRecording:t=>{e(e=>{e.isRecording=t})},setTimer:t=>{e(e=>{e.timer=t})},incrementTimer:()=>{e(e=>{e.timer+=1})},toggleMic:()=>{e(e=>{e.isRecording=!e.isRecording})},stopRecording:()=>{e(e=>{e.isRecording=!1})},startRecording:()=>{e(e=>{e.isRecording=!0})},resetTimer:()=>{e(e=>{e.timer=0})},recordVoiceMessage:()=>{e(e=>{e.isRecording||(e.isRecording=!0)})},timerReset:()=>{e(e=>{e.timer=0})}}))),en=e=>{try{if(!e.includes(X.USER_TIMES_REMAINING))return{isRemainingTime:!1,times:null};let t=e.replace(X.USER_TIMES_REMAINING,"").trim(),n=parseInt(t,10);if(isNaN(n))return console.warn("Не удалось преобразовать в число:",t),{isRemainingTime:!0,times:null};return{isRemainingTime:!0,times:n}}catch(e){return console.error("Ошибка парсинга времени из WebSocket сообщения:",e),{isRemainingTime:!1,times:null}}};var er=n(9504),ea=n(6105);let es=(e,t)=>{var n;let r=null!=(n=null==t?void 0:t.threshold)?n:10,a=(0,p.useRef)(null),[s,o]=(0,p.useState)(!0),i=(0,p.useRef)(e.length),l=(0,p.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"smooth",t=a.current;t&&("function"==typeof t.scrollTo?t.scrollTo({top:t.scrollHeight,behavior:e}):t.scrollTop=t.scrollHeight)},[]),c=(0,p.useCallback)(()=>{let e=a.current;e&&o(e.scrollHeight-e.scrollTop-e.clientHeight<=r)},[r]);return(0,p.useEffect)(()=>{let e=a.current;if(e)return e.addEventListener("scroll",c,{passive:!0}),()=>{e.removeEventListener("scroll",c)}},[c]),(0,p.useEffect)(()=>{let e=requestAnimationFrame(()=>{l("auto")});return()=>cancelAnimationFrame(e)},[l]),(0,p.useEffect)(()=>{let t=e.length>i.current;if(i.current=e.length,!t||!s)return;let n=requestAnimationFrame(()=>{l()});return()=>cancelAnimationFrame(n)},[e,s,l]),{containerRef:a,isAtBottom:s,scrollToBottom:l}},eo=()=>{var e;let t=(0,h.Jc)(),n=(0,h.EL)(),a=(0,h.t5)(),[s,o]=(0,p.useState)(""),[i,l]=(0,p.useState)(!0),c=(0,h.wn)(),u=(0,h.Kk)(),d=(0,er.zc)(),m=Y(e=>e.setIsActiveSession),g=K(),{currentTopicTitle:f}=(0,ea.L)();console.log(a);let{isRecording:v,timer:b,toggleMic:x,stopRecording:y,startRecording:j,resetTimer:w}=(()=>{let e=et(e=>e.isRecording),t=et(e=>e.timer),n=et(e=>e.toggleMic),r=et(e=>e.stopRecording),a=et(e=>e.startRecording),s=et(e=>e.incrementTimer),o=et(e=>e.resetTimer),i=(0,p.useRef)(null);return(0,p.useEffect)(()=>(e?i.current=setInterval(()=>{s()},1e3):i.current&&(clearInterval(i.current),i.current=null),()=>{i.current&&(clearInterval(i.current),i.current=null)}),[e,s]),{isRecording:e,timer:t,toggleMic:n,stopRecording:r,startRecording:a,resetTimer:o}})(),{messages:S,chatStatus:U,clearMessagesStore:A,addMessage:N}=(()=>{let e=Y(e=>e.messages),t=Y(e=>e.chatStatus),n=K(),r=Y(e=>e.addMessage),a=Y(e=>e.clearMessagesStore),{addChunk:s,finalize:o,hasChunks:i}=Q(),{audioStatus:l,onAudioChunk:c}=$(2e3);(0,p.useEffect)(()=>{if("end sending audio"===l&&i){let e=o();e&&r({id:(0,Z.A)(),audioData:new ArrayBuffer(0),objectUrl:e,role:"assistant",type:"audio"})}},[l,i,o,r]);let u=(0,p.useCallback)(e=>{try{let t=JSON.parse(e).message;if(!t)return;let n=t.match(/<b>Запрос пользователя:<\/b>\s*(.+)/),a=t.match(/<b>Ответ ассистента:<\/b>\s*(.+)/);if(n||a){let e={id:(0,Z.A)(),content:((null==n?void 0:n[1])||(null==a?void 0:a[1])||"").trim(),role:n?"user":"assistant",type:"text"};r(e)}}catch(a){let t=e.match(/<b>Запрос пользователя:<\/b>\s*(.+)/),n=e.match(/<b>Ответ ассистента:<\/b>\s*(.+)/);(t||n)&&r({id:(0,Z.A)(),content:((null==t?void 0:t[1])||(null==n?void 0:n[1])||"").trim(),role:t?"user":"assistant",type:"text"})}},[r]);return{messages:e,chatStatus:t,clearMessagesStore:a,addMessage:(0,p.useCallback)(e=>{n&&("string"==typeof e&&u(e),e instanceof ArrayBuffer&&(c(),s(e)))},[s,u,c,n])}})(),{containerRef:E}=es(S,{threshold:100}),{clearPlayedAudioIds:P,registerAudioRef:M,stopPlaingAudioMessageIfUserVoiceDiscovered:R,pauseAllAudio:k}=(e=>{let{messages:t}=e,[n,r]=(0,p.useState)(null),{isAudioAlreadyPlayed:a,setLastPlayedAudioId:s,clearLastPlayedAudioId:o}=ee(),i=(0,p.useRef)(new Map),l=(0,p.useCallback)((e,t)=>{i.current.set(e,t)},[]),c=(0,p.useCallback)(()=>{i.current.forEach(e=>{e.paused||e.pause()})},[]),u=(0,p.useCallback)(()=>{if(null==n?void 0:n.isPLaing){let e=i.current.get(n.id);e&&!e.paused&&(e.pause(),r(null))}},[n]),d=(0,p.useCallback)(e=>{if("string"==typeof e)try{JSON.parse(e).message===X.VOICE_DETECTED&&u()}catch(t){e===X.VOICE_DETECTED&&u()}},[u]);return(0,p.useEffect)(()=>{if(t.length>0){let e=t.findLast(e=>"assistant"===e.role&&"audio"===e.type);if(e&&"audio"===e.type){if((null==n?void 0:n.id)===e.id&&(null==n?void 0:n.isPLaing)||a(e.id))return;c(),setTimeout(()=>{let t=i.current.get(e.id);t&&(r({id:e.id,isPLaing:!0}),t.onended=()=>{r(null)},t.onpause=()=>{r(e=>e?{...e,isPLaing:!1}:null)},t.onplay=()=>{r(e=>e?{...e,isPLaing:!0}:null)},t.play(),s(e.id))},100)}}},[t,n,c,a,s]),{currentPlayingAudio:n,clearPlayedAudioIds:()=>{o()},registerAudioRef:l,pauseCurrentAudio:u,stopPlaingAudioMessageIfUserVoiceDiscovered:d,pauseAllAudio:c}})({messages:S}),{isActiveConnection:T,send:B,createConnection:I,closeConnect:D}=_({binaryType:"arraybuffer",url:C.J.realTimeChatWSConnect({voice:null==n?void 0:n.title,topic:null!=f?f:"",responseLength:null!=(e=null==a?void 0:a.id)?e:"normal"}),onMessage:e=>{if("string"==typeof e.data){let{isRemainingTime:t,times:n}=en(e.data);t&&n&&d(n)}R(e.data),N(e.data)},onOpen:()=>{c(),o("Соединение открыто"),console.log("onOpen")},onClose:()=>{u(),o("Соединение закрыто"),console.log("onClose")},onError:()=>{u(),console.log("Ошибка соединения")}}),{startRecordAudio:L,endRecordAudio:V}=(e=>{let{onResult:t,onError:n,onStream:r}=e,[a,s]=(0,p.useState)(!1),o=(0,p.useRef)(!1),i=(0,p.useRef)(null),l=(0,p.useRef)(null),c=(0,p.useRef)(null),u=(0,p.useRef)(null),d=(0,p.useRef)([]),h=(0,p.useCallback)(e=>{let t=e.length,n=new Int16Array(t);for(let r=0;r<t;r++)n[r]=32767*Math.min(1,e[r]);return n.buffer},[]),m=(0,p.useCallback)(e=>{let t=0;for(let n of e)t+=n.byteLength;let n=new ArrayBuffer(44+t),r=new DataView(n),a=(e,t)=>{for(let n=0;n<t.length;n++)r.setUint8(e+n,t.charCodeAt(n))};a(0,"RIFF"),r.setUint32(4,36+t,!0),a(8,"WAVE"),a(12,"fmt "),r.setUint32(16,16,!0),r.setUint16(20,1,!0),r.setUint16(22,1,!0),r.setUint32(24,16e3,!0),r.setUint32(28,32e3,!0),r.setUint16(32,2,!0),r.setUint16(34,16,!0),a(36,"data"),r.setUint32(40,t,!0);let s=44,o=new Uint8Array(n);for(let t of e){let e=new Uint8Array(t);o.set(e,s),s+=t.byteLength}return new Blob([n],{type:"audio/wav"})},[]),g=(0,p.useCallback)(async()=>{if(!a)try{let e=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:16e3,channelCount:1}});u.current=e;let t=new(window.AudioContext||window.webkitAudioContext);i.current=t;let n=t.createMediaStreamSource(e);c.current=n;let a=t.createScriptProcessor(16384,1,1);l.current=a,d.current=[],a.onaudioprocess=e=>{if(o.current){let t=e.inputBuffer.getChannelData(0),n=h(t);if(d.current.push(n),r){let e=new Blob([n],{type:"audio/pcm"});r({arrayBuffer:n,blob:e})}}},n.connect(a),a.connect(t.destination),s(!0),o.current=!0}catch(t){let e=t instanceof Error?t.message:"Неизвестная ошибка";console.error("❌ Ошибка запуска записи:",e),null==n||n("Ошибка доступа к микрофону: ".concat(e))}},[a,r,n,h]);return{isRecordAudio:a,startRecordAudio:g,endRecordAudio:(0,p.useCallback)(()=>{if(s(!1),o.current=!1,l.current&&(l.current.disconnect(),l.current=null),c.current&&(c.current.disconnect(),c.current=null),i.current&&(i.current.close(),i.current=null),u.current&&(u.current.getTracks().forEach(e=>e.stop()),u.current=null),t&&d.current.length>0){let e=m(d.current);t({voiceBlob:e,wavBlob:e})}d.current=[]},[t,m])}})({onStream:e=>{let{arrayBuffer:t}=e;B(t)}});return(0,p.useEffect)(()=>{T||(V(),y())},[T]),(0,p.useEffect)(()=>{w(),y(),V()},[null==n?void 0:n.title,null==t?void 0:t.title,null==a?void 0:a.id]),(0,r.jsx)(J,{scrollRef:E,data:S,infoMessage:null!=s?s:"",initChatMessage:U||"Запишите голосовое сообщение, чтобы начать",timer:b,isRecording:v,endButtonClick:()=>{V(),w(),y(),k(),m(!1)},handleMicClick:()=>{v?V():L(),T||I(),g||(A(),m(!0)),x()},isExpanded:i,expandButtonClick:()=>l(!i),children:e=>{switch(e.type){case"text":return(0,r.jsx)(h.cM,{role:e.role,children:e.content},e.id);case"audio":return(0,r.jsx)(h.sv,{ref:t=>{t&&M(e.id,t)},controls:!0,src:e.objectUrl},e.id);default:return null}}})};var ei=n(412),el=n.n(ei);let ec=e=>{let{isExpanded:t,expandButtonClick:n,messages:a,isRecording:s,onRecordClick:i,onStopClick:l,initialChatMessage:c,recordingHandlers:u,infoMessage:d,scrollRef:h,children:m}=e;return(0,r.jsx)(k,{scrollRef:h,messagesNode:null==a?void 0:a.map((e,t)=>m(e)),initialChatMessage:c,infoMessage:d,isExpanded:t,topSlot:(0,r.jsxs)("div",{className:el().action_buttons,children:[(0,r.jsx)(U,{onClick:l}),(0,r.jsx)(G,{isExpanded:t,onClick:n}),(0,r.jsx)(F,{})]}),footerSlot:(0,r.jsx)(o.$n,{variant:s?"secondary":"orange",className:el().record_button,onClick:i,...u&&{onMouseDown:u.onMouseDown,onMouseUp:u.onMouseUp,onMouseLeave:u.onMouseLeave,onTouchStart:u.onTouchStart,onTouchEnd:u.onTouchEnd,onTouchCancel:u.onTouchCancel},children:s?"\uD83D\uDD34 Recording...":"\uD83C\uDFA4 Hold to record"})})};var eu=n(549),ed=n(4525);let eh=async e=>{let{wavBlob:t,clientId:n}=e,r=new FormData;r.append("file",t,"audio.wav"),r.append("client_id",n);let a=await ed.F.post(C.J.uploadAudioInVoicesChat,{body:r});return await a.json()},em=(0,z.v)()((0,q.D)(e=>({messages:[],chatStatus:"",addMessage:t=>{e(e=>{e.messages.push(t)})},setChatStatus:t=>{e(e=>{e.chatStatus=t})},clearMessagesStore:()=>{e(e=>{e.messages=[],e.chatStatus=""})}}))),eg=()=>{var e;let[t,n]=(0,p.useState)(""),[a,s]=(0,p.useState)(""),[o,i]=(0,p.useState)(!0),l=(0,h.wn)(),c=(0,h.Kk)(),u=(0,er.zc)(),d=(0,h.EL)(),m=(0,h.t5)(),{currentTopicTitle:g}=(0,h.LW)(),{messages:f,addVoiceAudioData:v,addVoiceTextMessage:b,clearVoiceMessagesStore:x}=(()=>{let e=em(e=>e.messages),t=em(e=>e.chatStatus),n=em(e=>e.addMessage),r=em(e=>e.clearMessagesStore),{addChunk:a,finalize:s,hasChunks:o}=Q(),{audioStatus:i,onAudioChunk:l}=$(2e3);return(0,p.useEffect)(()=>{if("end sending audio"===i&&o){let e=s();e&&n({id:(0,Z.A)(),role:"assistant",type:"audio",audioData:"",objectUrl:e})}},[i,o,s,n]),{messages:e,chatStatus:t,clearVoiceMessagesStore:r,addVoiceAudioData:e=>{a(e),l()},addVoiceTextMessage:e=>{let t,r;if("string"!=typeof e.data)return;let a=e.data;if(a.includes("<b>Ответ ассистента:</b>"))t="assistant",r=a.replace("<b>Ответ ассистента:</b>","").trim();else{if(!a.includes("<b>Запрос пользователя:</b>"))return;t="user",r=a.replace("<b>Запрос пользователя:</b>","").trim()}n({id:(0,Z.A)(),role:t,type:"text",content:r})},addVoiceMessage:n}})(),{containerRef:y}=es(f,{threshold:100}),{registerAudioRef:j,clearPlayedAudioIds:w,pauseAllAudio:S}=(e=>{let{messages:t,isExpanded:n}=e,[r,a]=(0,p.useState)(null),{isAudioAlreadyPlayed:s,setLastPlayedAudioId:o,clearLastPlayedAudioId:i}=ee(),l=(0,p.useRef)(new Map),c=(0,p.useRef)(t.length),u=(0,p.useCallback)((e,t)=>{l.current.set(e,t)},[]),d=(0,p.useCallback)(()=>{l.current.forEach(e=>{e.paused||e.pause()})},[]);return(0,p.useEffect)(()=>{let e=t.length>c.current;if(c.current=t.length,!e)return;let i=t[t.length-1];if(n)return void o(i.id);if(t.length>0){let e=t.findLast(e=>"assistant"===e.role&&"audio"===e.type);if(e&&"audio"===e.type){if((null==r?void 0:r.id)===e.id&&(null==r?void 0:r.isPLaing)||s(e.id))return;d(),setTimeout(()=>{let t=l.current.get(e.id);t&&(a({id:e.id,isPLaing:!0}),t.onended=()=>{a(null)},t.onpause=()=>{a(e=>e?{...e,isPLaing:!1}:null)},t.onplay=()=>{a(e=>e?{...e,isPLaing:!0}:null)},t.play(),o(e.id))},100)}}},[t,r,d,s,o]),{currentPlayingAudio:r,clearPlayedAudioIds:()=>{i()},registerAudioRef:u,pauseAllAudio:d}})({messages:f,isExpanded:o}),{isActiveConnection:U,closeConnect:A,createConnection:N}=_({binaryType:"arraybuffer",url:C.J.voiceMessagesWSConnect({voice:null==d?void 0:d.title,topic:g||"",responseLength:null!=(e=null==m?void 0:m.id)?e:"normal"}),onMessage:e=>{if("string"==typeof e.data){let{isRemainingTime:t,times:r}=en(e.data);if(t&&r&&u(r),e.data.startsWith("CONNECTED:")){let t=(e=>{try{let t=JSON.parse(e);if(t.message&&t.message.startsWith("CONNECTED:"))return t.message.replace("CONNECTED:","");return null}catch(t){return console.warn("JSON parsing error:",t),console.warn("Plain string received",e),e.replace("CONNECTED:","")}})(e.data);t&&(n(t),console.log(t))}else b(e)}e.data instanceof ArrayBuffer&&v(e.data)},onOpen:()=>{l(),s("Соединение установлено")},onClose:()=>{console.log("Голосовй чат закрыт"),s("Соединение разорвано"),c()},onError:e=>{console.error("Voice message chat error:",e),c()}}),{mutate:E}=(0,eu.n)({mutationFn:eh,onSuccess:e=>{console.log("Audio uploaded successfully:",e)},onError:e=>{console.error("Error uploading audio:",e)}}),{startRecord:P,endRecord:M,isRecording:R}=(e=>{let{onResult:t,onError:n,onStream:r}=e,[a,s]=(0,p.useState)(!1),o=(0,p.useRef)(null),i=(0,p.useRef)(null),l=(0,p.useRef)([]),c=(0,p.useCallback)(e=>{let t=e.sampleRate,n=e.getChannelData(0),r=2*n.length,a=new ArrayBuffer(44+r),s=new DataView(a),o=(e,t)=>{for(let n=0;n<t.length;n++)s.setUint8(e+n,t.charCodeAt(n))};o(0,"RIFF"),s.setUint32(4,36+r,!0),o(8,"WAVE"),o(12,"fmt "),s.setUint32(16,16,!0),s.setUint16(20,1,!0),s.setUint16(22,1,!0),s.setUint32(24,t,!0),s.setUint32(28,2*t,!0),s.setUint16(32,2,!0),s.setUint16(34,16,!0),o(36,"data"),s.setUint32(40,r,!0);let i=44;for(let e=0;e<n.length;e++,i+=2){let t=Math.max(-1,Math.min(1,n[e]));s.setInt16(i,32767*t,!0)}return new Blob([a],{type:"audio/wav"})},[]),u=(0,p.useCallback)(async e=>{try{let t=new(window.AudioContext||window.webkitAudioContext),n=await e.arrayBuffer(),r=await t.decodeAudioData(n);return t.close(),c(r)}catch(t){return console.error("Ошибка конвертации в WAV:",t),new Blob([e],{type:"audio/wav"})}},[c]),d=(0,p.useCallback)(async()=>{try{let e=await navigator.mediaDevices.getUserMedia({audio:!0});i.current=e;let a=new MediaRecorder(e);o.current=a,l.current=[],a.addEventListener("dataavailable",async e=>{if(e.data.size>0&&(l.current.push(e.data),r)){let t=await e.data.arrayBuffer();r({arrayBuffer:t,blob:e.data})}}),a.addEventListener("stop",async()=>{let e=new Blob(l.current,{type:"audio/webm"}),n=await u(e);null==t||t({voiceBlob:e,wavBlob:n}),i.current&&(i.current.getTracks().forEach(e=>e.stop()),i.current=null),o.current=null,l.current=[],s(!1)}),a.addEventListener("error",e=>{let t="Ошибка MediaRecorder: ".concat(e.error);null==n||n(t),s(!1)})}catch(t){let e=t instanceof Error?t.message:"Неизвестная ошибка";null==n||n("Ошибка доступа к микрофону: ".concat(e))}},[t,n,r,u,c]),h=(0,p.useCallback)(async()=>{var e;if(!a&&(null==(e=o.current)?void 0:e.state)!=="recording")try{await d(),o.current&&"inactive"===o.current.state&&(o.current.start(100),s(!0))}catch(t){let e=t instanceof Error?t.message:"Неизвестная ошибка";null==n||n("Ошибка начала записи: ".concat(e))}},[a,d,n]);return{isRecording:a,startRecord:h,endRecord:(0,p.useCallback)(()=>{o.current&&"recording"===o.current.state&&o.current.stop()},[])}})({onResult:e=>{E({wavBlob:e.wavBlob,clientId:t})},onError:e=>{console.error("Ошибка записи:",e)}}),k=()=>{M()},T=()=>{M()};return(0,r.jsx)(ec,{scrollRef:y,infoMessage:a,messages:f,isRecording:R,onRecordClick:()=>{U||N()},onStopClick:()=>{M(),x(),A(),S(),w()},isExpanded:o,expandButtonClick:()=>i(!o),initialChatMessage:f.length?"":"Hold the button to record a voice message",recordingHandlers:{onMouseDown:e=>{U||N(),P()},onMouseUp:k,onMouseLeave:k,onTouchStart:e=>{U||N(),P()},onTouchEnd:T,onTouchCancel:T},children:e=>"assistant"===e.role&&"audio"===e.type?(0,r.jsx)(h.sv,{ref:t=>{t&&j(e.id,t)},src:e.objectUrl,controls:!0},e.id):"text"===e.type?(0,r.jsx)(h.cM,{role:e.role,children:e.content},e.id):void 0})},ep=()=>{let e=(0,l.useSearchParams)().get("mode");return"realtime"===e?(0,r.jsx)(eo,{}):"voice"===e?(0,r.jsx)(eg,{}):null},e_=e=>{let{className:t}=e,n=(0,l.useRouter)();return(0,l.useSearchParams)().get("mode"),(0,r.jsx)("section",{className:(0,i.A)(s().section,t),children:(0,r.jsx)(o.mc,{children:(0,r.jsxs)("div",{className:s().demoContainer,children:[(0,r.jsx)("button",{className:s().closeButton,onClick:()=>n.push(c.J.homePage),type:"button",children:"\xd7"}),(0,r.jsxs)(o.xA,{children:[(0,r.jsxs)("div",{className:s().demoContent,children:[(0,r.jsxs)("div",{className:s().demoHeader,children:[(0,r.jsx)("h1",{className:s().demoTitle,children:"Start conversation right now"}),(0,r.jsx)("p",{className:s().demoDescription,children:"1 minute demo conversation free, no registration"})]}),(0,r.jsx)(m,{}),(0,r.jsx)(ep,{}),(0,r.jsx)("p",{className:s().helpText,children:"Choose a mode to start communication"})]}),(0,r.jsx)("div",{className:s().demoImage,children:(0,r.jsx)(g.y,{})})]})]})})})}},2740:(e,t,n)=>{Promise.resolve().then(n.t.bind(n,2619,23)),Promise.resolve().then(n.bind(n,4810)),Promise.resolve().then(n.bind(n,3034)),Promise.resolve().then(n.bind(n,8402)),Promise.resolve().then(n.bind(n,3876)),Promise.resolve().then(n.bind(n,7522)),Promise.resolve().then(n.bind(n,7810)),Promise.resolve().then(n.bind(n,3514)),Promise.resolve().then(n.bind(n,6018)),Promise.resolve().then(n.bind(n,2242)),Promise.resolve().then(n.bind(n,6388)),Promise.resolve().then(n.bind(n,3962)),Promise.resolve().then(n.bind(n,3076)),Promise.resolve().then(n.bind(n,4537)),Promise.resolve().then(n.bind(n,1972)),Promise.resolve().then(n.bind(n,4155)),Promise.resolve().then(n.bind(n,3204)),Promise.resolve().then(n.bind(n,5637)),Promise.resolve().then(n.bind(n,1893)),Promise.resolve().then(n.bind(n,933)),Promise.resolve().then(n.bind(n,9877)),Promise.resolve().then(n.bind(n,1534)),Promise.resolve().then(n.bind(n,2135)),Promise.resolve().then(n.bind(n,4443)),Promise.resolve().then(n.bind(n,7097)),Promise.resolve().then(n.bind(n,6497))},3076:(e,t,n)=>{"use strict";n.d(t,{AuthPage:()=>c});var r=n(5155),a=n(2115),s=n(8049),o=n(2821),i=n(7423),l=n.n(i);let c=e=>{let{className:t}=e,[n,i]=(0,a.useState)("login"),[c,u]=(0,a.useState)(!1),[d,h]=(0,a.useState)(!1),m=e=>{e.preventDefault(),u(!1),h(!1),"login"===n?u(!0):(h(!0),setTimeout(()=>{i("login"),h(!1)},2e3))},g=e=>{alert("".concat(e," authorization (demo)"))};return(0,r.jsx)("div",{className:(0,o.A)(l().page,t),children:(0,r.jsx)("section",{className:l().authSection,children:(0,r.jsx)(s.mc,{children:(0,r.jsx)("div",{className:l().authContainer,children:(0,r.jsx)(s.Zp,{className:l().authCard,padding:"lg",children:"login"===n?(0,r.jsxs)("div",{className:l().authForm,children:[(0,r.jsxs)("div",{className:l().authHeader,children:[(0,r.jsx)("h1",{className:l().authTitle,children:"Welcome to FluentGo"}),(0,r.jsx)("p",{className:l().authDescription,children:"Sign in to your account or register to continue"})]}),(0,r.jsxs)("form",{onSubmit:m,className:l().form,children:[(0,r.jsx)("div",{className:l().inputGroup,children:(0,r.jsx)("input",{type:"email",className:l().input,placeholder:"Enter email",required:!0})}),(0,r.jsx)("div",{className:l().inputGroup,children:(0,r.jsx)("input",{type:"password",className:l().input,placeholder:"Enter password",required:!0})}),c&&(0,r.jsx)("div",{className:l().errorMessage,children:"Invalid email or password"}),(0,r.jsx)(s.$n,{type:"submit",variant:"primary",className:l().submitButton,children:"Sign In"})]}),(0,r.jsx)("div",{className:l().forgotPassword,children:(0,r.jsx)("button",{type:"button",className:l().forgotLink,onClick:()=>alert("Password recovery feature (in development)"),children:"Forgot password?"})}),(0,r.jsx)("div",{className:l().divider,children:(0,r.jsx)("span",{children:"or"})}),(0,r.jsx)(s.$n,{variant:"secondary",className:l().switchButton,onClick:()=>i("register"),children:"Register"}),(0,r.jsxs)("div",{className:l().socialButtons,children:[(0,r.jsxs)("button",{className:l().socialButton,onClick:()=>g("Google"),type:"button",children:[(0,r.jsxs)("svg",{className:l().socialIcon,viewBox:"0 0 24 24",children:[(0,r.jsx)("path",{fill:"#4285F4",d:"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"}),(0,r.jsx)("path",{fill:"#34A853",d:"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"}),(0,r.jsx)("path",{fill:"#FBBC05",d:"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"}),(0,r.jsx)("path",{fill:"#EA4335",d:"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"})]}),(0,r.jsx)("span",{children:"Sign in with Google"})]}),(0,r.jsxs)("button",{className:l().socialButton,onClick:()=>g("Facebook"),type:"button",children:[(0,r.jsx)("svg",{className:l().socialIcon,fill:"#1877F2",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{d:"M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"})}),(0,r.jsx)("span",{children:"Sign in with Facebook"})]})]})]}):(0,r.jsxs)("div",{className:l().authForm,children:[(0,r.jsxs)("div",{className:l().authHeader,children:[(0,r.jsx)("h1",{className:l().authTitle,children:"Create Account"}),(0,r.jsx)("p",{className:l().authDescription,children:"Fill out the form to register"})]}),(0,r.jsxs)("form",{onSubmit:m,className:l().form,children:[(0,r.jsx)("div",{className:l().inputGroup,children:(0,r.jsx)("input",{type:"text",className:l().input,placeholder:"Enter name",required:!0})}),(0,r.jsx)("div",{className:l().inputGroup,children:(0,r.jsx)("input",{type:"email",className:l().input,placeholder:"Enter email",required:!0})}),(0,r.jsx)("div",{className:l().inputGroup,children:(0,r.jsx)("input",{type:"password",className:l().input,placeholder:"Enter password",required:!0})}),(0,r.jsx)("div",{className:l().inputGroup,children:(0,r.jsx)("input",{type:"password",className:l().input,placeholder:"Confirm password",required:!0})}),d&&(0,r.jsx)("div",{className:l().successMessage,children:"Account created! You can now log in"}),(0,r.jsx)(s.$n,{type:"submit",variant:"primary",className:l().submitButton,children:"Create Account"})]}),(0,r.jsx)("div",{className:l().divider,children:(0,r.jsx)("span",{children:"or"})}),(0,r.jsx)(s.$n,{variant:"secondary",className:l().switchButton,onClick:()=>i("login"),children:"Already have an account? Sign In"})]})})})})})})}},3203:e=>{e.exports={controls:"RealTimeChatUI_controls___xVXa",micSection:"RealTimeChatUI_micSection__3lV_b",statusSection:"RealTimeChatUI_statusSection__uBjsR",statusText:"RealTimeChatUI_statusText__uJvYt",timer:"RealTimeChatUI_timer__ZbLPu",actionButtons:"RealTimeChatUI_actionButtons__dFgtV"}},4537:(e,t,n)=>{"use strict";n.d(t,{MainPage:()=>m});var r=n(5155);n(5637),n(3204);var a=n(9877),s=n(2135),o=n(1534),i=n(7097),l=n(933),c=n(6497),u=n(4443);n(7186);var d=n(1893),h=n(4155);let m=()=>(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(l.HeroSection,{}),(0,r.jsx)(c.WhyItWorksSection,{}),(0,r.jsx)(a.HowItWorksSection,{}),(0,r.jsx)(i.VideoPreviewSection,{}),(0,r.jsx)(u.TopicsSection,{}),(0,r.jsx)(s.ReviewsSection,{}),(0,r.jsx)(o.PricingSection,{}),(0,r.jsx)(d.HelpSection,{}),(0,r.jsx)(h.FinalCTA,{})]})},4598:e=>{e.exports={expandButton:"ExpandButton_expandButton__gxGu2"}},4627:e=>{e.exports={micButton:"MicButton_micButton__Mtt3n",pulse:"MicButton_pulse__HA4P6",active:"MicButton_active__Z25BT","pulse-active":"MicButton_pulse-active___7AyL"}},5548:()=>{},7423:e=>{e.exports={page:"AuthPage_page__8HF7Q",authSection:"AuthPage_authSection__L4pr4",authContainer:"AuthPage_authContainer___bodD",authCard:"AuthPage_authCard__AnGmi",authForm:"AuthPage_authForm__4MOyS",authHeader:"AuthPage_authHeader__B4tr0",authTitle:"AuthPage_authTitle__3QOYw",authDescription:"AuthPage_authDescription__ilxV3",form:"AuthPage_form__PQkN4",inputGroup:"AuthPage_inputGroup__trMjf",input:"AuthPage_input__PJzNI",submitButton:"AuthPage_submitButton__cv2tl",switchButton:"AuthPage_switchButton__ljbEC",forgotPassword:"AuthPage_forgotPassword__CAFDY",forgotLink:"AuthPage_forgotLink__vvYlF",divider:"AuthPage_divider__Brqzu",errorMessage:"AuthPage_errorMessage__zy6Tn",successMessage:"AuthPage_successMessage__M8wtI",socialButtons:"AuthPage_socialButtons__XqWfX",socialButton:"AuthPage_socialButton__9WDzr",socialIcon:"AuthPage_socialIcon__8WSrv"}},9244:e=>{e.exports={modeSelector:"ChangeChatMode_modeSelector__dfvy1",modeTab:"ChangeChatMode_modeTab__KFMNb",active:"ChangeChatMode_active__Wn7tw"}},9780:e=>{e.exports={section:"CombinedChatComponent_section___Gzy4",demoContainer:"CombinedChatComponent_demoContainer__R97_2",closeButton:"CombinedChatComponent_closeButton__ilJXv",demoContent:"CombinedChatComponent_demoContent__vVU8Z",demoHeader:"CombinedChatComponent_demoHeader__uvaMq",demoTitle:"CombinedChatComponent_demoTitle__ngVvD",demoDescription:"CombinedChatComponent_demoDescription__9RdWx",modeSelector:"CombinedChatComponent_modeSelector__5dSRl",modeTab:"CombinedChatComponent_modeTab__mUx2M",active:"CombinedChatComponent_active___Y40F",realtimeInterface:"CombinedChatComponent_realtimeInterface__CZmkg",chatLog:"CombinedChatComponent_chatLog__hESuO",emptyState:"CombinedChatComponent_emptyState__6YPYu",message:"CombinedChatComponent_message__9e5Op",user:"CombinedChatComponent_user__VaKKn",assistant:"CombinedChatComponent_assistant__EgC5j",voiceInterface:"CombinedChatComponent_voiceInterface__goddA",voiceControls:"CombinedChatComponent_voiceControls__mcLZo",recordButton:"CombinedChatComponent_recordButton__2JfMr",helpText:"CombinedChatComponent_helpText__MV0yf",demoImage:"CombinedChatComponent_demoImage__8R8O6",imageCard:"CombinedChatComponent_imageCard__bgbIQ",characterImage:"CombinedChatComponent_characterImage__31g_H"}}}]);