========================================================
API для автоматических подписок (PayPal)
========================================================

Обзор

API позволяет создавать подписки с автоматическими рекуррентными платежами через PayPal. После того, как пользователь одобряет подписку, PayPal автоматически списывает средства согласно выбранному тарифному плану.

Базовый URL для тестирования: https://esim-sandbox.oxem.dev

Authorization: Bearer preview-external-api-secret-2024

Базовый URL для production: https://airalo-api.oxem.dev


========================================================
Ключевые возможности (таблица → JSON)
========================================================

{
  "features": [
    "Автоматические рекуррентные списания (управляются PayPal)",
    "Поддержка множества валют: USD, EUR, GBP, JPY, CAD, AUD, RUB",
    "Одобрение подписки через PayPal UI",
    "Webhook уведомления о каждом платеже",
    "Управление подпиской: пауза, возобновление, отмена",
    "История всех транзакций",
    "Поддержка custom_data"
  ]
}
// Комментарий: исходная таблица сконвертирована в JSON-список.


========================================================
Как это работает
========================================================

PayPal сам управляет billing cycles:

Создание подписки  
Одобрение пользователем  
Автоматические списания  
Webhook уведомления  

Важно: PayPal полностью управляет циклами списаний — ваш сервер не делает периодические запросы.


========================================================
API Endpoints
========================================================

--------------------------------------------------------
1. Создание подписки
--------------------------------------------------------

Endpoint: POST /api/external/subscriptions/create

Параметры запроса (таблица → JSON):

{
  "parameters": {
    "payment_provider": {
      "type": "string",
      "required": true,
      "allowed": ["PAYPAL"]
    },
    "amount": {
      "type": "number",
      "required": true,
      "description": "Сумма в центах"
    },
    "currency": {
      "type": "string",
      "required": true,
      "allowed": ["USD","EUR","GBP","JPY","CAD","AUD","RUB"]
    },
    "interval_count": {
      "type": "number",
      "required": true,
      "description": "Количество единиц интервала"
    },
    "interval_unit": {
      "type": "string",
      "required": true,
      "allowed": ["DAY","MONTH"]
    },
    "product_title": {
      "type": "string",
      "required": true
    },
    "webhook_url": {
      "type": "string",
      "required": true,
      "description": "HTTPS URL"
    },
    "custom_data": {
      "type": "object",
      "required": true
    },
    "auth_token": {
      "type": "string",
      "required": false
    }
  }
}
// Комментарий: таблица параметров полностью перенесена в JSON.


Пример запроса  
(оставлено без изменений)

Успешный ответ  
(оставлено без изменений)

Поля ответа (таблица → JSON):

{
  "response_fields": {
    "subscription_id": "Уникальный ID подписки",
    "payment_url": "URL одобрения в PayPal",
    "status": "Начальный статус: PENDING",
    "payment_provider": "PAYPAL"
  }
}

Возможные ошибки (таблица → JSON):

{
  "errors": [
    {"status":400,"description":"Некорректные параметры"},
    {"status":401,"description":"Неверный токен"},
    {"status":500,"description":"Внутренняя ошибка"}
  ]
}


--------------------------------------------------------
2. Получение статуса подписки
--------------------------------------------------------

Endpoint: GET /api/external/subscriptions/:subscription_id/status

Параметры пути (таблица → JSON):

{
  "path_parameters": {
    "subscription_id": {
      "type": "string",
      "format": "UUID"
    }
  }
}

Статусы подписки (таблица → JSON):

{
  "statuses": {
    "PENDING": "Ожидает одобрения",
    "ACTIVE": "Активна, автоматические списания работают",
    "PAUSED": "Приостановлена",
    "CANCELLED": "Отменена",
    "EXPIRED": "Истекла"
  }
}


--------------------------------------------------------
3. Приостановка подписки
--------------------------------------------------------

Endpoint: POST /api/external/subscriptions/:subscription_id/pause

Параметры запроса (таблица → JSON):

{
  "parameters": {
    "reason": {
      "type": "string",
      "required": false
    }
  }
}


--------------------------------------------------------
4. Возобновление подписки
--------------------------------------------------------

Endpoint: POST /api/external/subscriptions/:subscription_id/resume

Параметры запроса — такая же таблица → JSON:

{
  "parameters": {
    "reason": {
      "type": "string",
      "required": false
    }
  }
}


--------------------------------------------------------
5. Отмена подписки
--------------------------------------------------------

Endpoint: POST /api/external/subscriptions/:subscription_id/cancel

Параметры запроса — таблица → JSON:

{
  "parameters": {
    "reason": {
      "type": "string",
      "required": false
    }
  }
}

Комментарий: отмененная подписка не восстанавливается.


--------------------------------------------------------
6. История платежей
--------------------------------------------------------

Endpoint: GET /api/external/subscriptions/:subscription_id/charges

Параметры запроса (таблица → JSON):

{
  "parameters": {
    "limit": {
      "type": "number",
      "default": 50,
      "max": 100
    },
    "offset": {
      "type": "number",
      "default": 0
    }
  }
}


========================================================
Webhook уведомления
========================================================

События подписки (таблица → JSON):

{
  "events": {
    "PAYMENT.COMPLETED": "успешное списание",
    "PAYMENT.FAILED": "неудачное списание",
    "SUBSCRIPTION.ACTIVATED": "подписка активирована",
    "SUBSCRIPTION.SUSPENDED": "приостановлена",
    "SUBSCRIPTION.CANCELLED": "отменена",
    "SUBSCRIPTION.EXPIRED": "истекла"
  }
}
// Комментарий: ключевые события, которые PayPal шлет через webhook.


========================================================
Webhook: PAYMENT.COMPLETED
========================================================

(оставлено без изменений — это не таблица)


========================================================
Webhook: PAYMENT.FAILED
========================================================

Возможные причины (таблица → JSON):

{
  "failure_reasons": [
    "Недостаточно средств",
    "Карта заблокирована",
    "Карта истекла",
    "Превышен лимит",
    "Проблемы банка"
  ]
}


========================================================
Webhook: SUBSCRIPTION.SUSPENDED
========================================================

(оставлено без изменений)


========================================================
Webhook: SUBSCRIPTION.CANCELLED
========================================================

(оставлено без изменений)


========================================================
Webhook: SUBSCRIPTION.EXPIRED
========================================================

(оставлено без изменений)


========================================================
Особенности webhook (таблица → JSON)
========================================================

{
  "webhook_features": {
    "flatten_custom_data": true,
    "authorization": "Bearer auth_token если был указан",
    "retry_logic": "до 3 попыток",
    "timeout": "30 секунд",
    "idempotency": "charge_id может повторяться"
  }
}


========================================================
Тестирование
========================================================

Тестовый endpoint  
(оставлено без изменений)

Тестовые аккаунты (таблица → JSON):

{
  "paypal_sandbox_accounts": {
    "personal": {
      "email": "sb-a7xm04953385@personal.example.com",
      "password": "n_R3vU}Z",
      "type": "Personal"
    }
  }
}


========================================================
Безопасность
========================================================

Проверка webhook токена  
(оставлено без изменений)

HTTPS обязателен  
(оставлено без изменений)

Проверка charge_id (таблица → JSON):

{
  "idempotency_rules": {
    "avoid_duplicates": "Не обрабатывайте charge_id повторно",
    "example": "processedCharges.add(charge_id)"
  }
}

Безопасное хранение ключей  
(оставлено без изменений)

Валидация данных  
(оставлено без изменений)
