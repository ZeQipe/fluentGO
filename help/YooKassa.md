========================================================
API для платежей с сохраненной картой (YooKassa)
========================================================

Обзор

API позволяет создавать подписки с сохранением карты пользователя для последующих списаний по требованию. После первого платежа с 3DS аутентификацией карта сохраняется, и вы можете списывать средства в любой момент через API без участия пользователя.

Базовый URL для тестирования: https://esim-sandbox.oxem.dev
Все запросы к тестовому хосту требуют заголовок:

Authorization: Bearer preview-external-api-secret-2024

Базовый URL для production: https://airalo-api.oxem.dev


========================================================
Ключевые возможности (была таблица → JSON)
========================================================

{
  "features": [
    "Сохранение карты после первого платежа с 3DS",
    "Списание средств по требованию через API",
    "Полный контроль над моментом списания",
    "Webhook уведомления о каждом платеже",
    "Возможность списывать любые суммы",
    "История всех транзакций",
    "Поддержка custom_data"
  ]
}
// Комментарий: исходная таблица конвертирована в список.


========================================================
Как это работает
========================================================

Создание подписки - пользователь проходит первый платеж с 3DS, карта сохраняется  
Ручное списание - когда нужно, вы вызываете API  
Webhook - вы получаете уведомление о результате каждого списания

Важно: автоматических списаний по расписанию нет.


========================================================
API Endpoints
========================================================

--------------------------------------------------------
1. Создание подписки (сохранение карты)
--------------------------------------------------------

Endpoint: POST /api/external/subscriptions/create

Параметры запроса (таблица → JSON):

{
  "parameters": {
    "amount": {
      "type": "number",
      "required": true,
      "description": "Сумма первого платежа в копейках"
    },
    "currency": {
      "type": "string",
      "required": true,
      "allowed": ["RUB"]
    },
    "product_title": {
      "type": "string",
      "required": true
    },
    "webhook_url": {
      "type": "string",
      "required": true,
      "description": "HTTPS URL для webhook"
    },
    "custom_data": {
      "type": "object",
      "required": true,
      "description": "Плоский объект с примитивами"
    },
    "auth_token": {
      "type": "string",
      "required": false
    },
    "customer_email": {
      "type": "string",
      "required": false
    }
  }
}
// Комментарий: таблица конвертирована в структурированный объект.


Пример запроса  
(оставлено без изменений)

curl -X POST https://esim-sandbox.oxem.dev/api/external/subscriptions/create \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer preview-external-api-secret-2024" \
  -d '{
    "amount": 10000,
    "currency": "RUB",
    "product_title": "Оплата услуг",
    "webhook_url": "https://myservice.com/webhook",
    "auth_token": "my_webhook_secret",
    "custom_data": {
      "user_id": "12345",
      "service_type": "consulting"
    },
    "customer_email": "user@example.com"
  }'

Успешный ответ  
(оставлено без изменений)

{
  "subscription_id": "...",
  "payment_url": "...",
  "status": "success"
}

Процесс первого платежа  
(оставлено без изменений)

Возможные ошибки (таблица → JSON):

{
  "errors": [
    {"status": 400, "description": "Некорректные параметры"},
    {"status": 401, "description": "Неверный токен"},
    {"status": 500, "description": "Внутренняя ошибка"}
  ]
}


--------------------------------------------------------
2. Списание средств
--------------------------------------------------------

Endpoint: POST /api/external/subscriptions/:subscription_id/charge

Параметры пути (таблица → JSON):

{
  "path_parameters": {
    "subscription_id": {
      "type": "string",
      "format": "UUID"
    }
  }
}

Параметры запроса (таблица → JSON):

{
  "parameters": {
    "amount": {
      "type": "number",
      "required": false,
      "description": "Если не указана — используется сумма подписки"
    },
    "idempotency_key": {
      "type": "string",
      "required": false,
      "description": "Ключ для избежания дублей"
    }
  }
}


Примеры запросов  
(оставлено без изменений)

Успешный ответ  
(оставлено без изменений)

Ответ при ошибке  
(оставлено без изменений)

Возможные ошибки (таблица → JSON):

{
  "errors": [
    {"status": 400, "description": "Подписка не активна или недостаточно средств"},
    {"status": 404, "description": "Подписка не найдена"},
    {"status": 500, "description": "Внутренняя ошибка"}
  ]
}


--------------------------------------------------------
3. История платежей
--------------------------------------------------------

Endpoint: GET /api/external/subscriptions/:subscription_id/charges

Параметры запроса (таблица → JSON):

{
  "parameters": {
    "limit": {
      "type": "number",
      "default": 50,
      "max": 100
    },
    "offset": {
      "type": "number",
      "default": 0
    }
  }
}

Пример запроса  
(оставлено без изменений)

Успешный ответ  
(оставлено без изменений)


========================================================
Webhook уведомления
========================================================

Формат уведомления  
(оставлено без изменений)

Webhook поля (таблица → JSON):

{
  "webhook_payload_fields": {
    "subscription_id": "UUID подписки",
    "charge_id": "UUID транзакции",
    "order_id": "Идентификатор заказа",
    "amount": "Сумма списания",
    "currency": "Валюта",
    "status": "Статус списания",
    "scheduled_at": "Плановое время",
    "processed_at": "Время обработки",
    "failure_reason": "Причина ошибки",
    "//": "custom_data внедряется в корень объекта"
  }
}

Особенности webhook (таблица → JSON):

{
  "webhook_features": {
    "flatten_custom_data": true,
    "authorization": "Bearer auth_token если был указан",
    "retry": "до 3 попыток",
    "timeout": "30 секунд"
  }
}


========================================================
Полный пример интеграции
========================================================

(оставлено без изменений)


========================================================
Тестирование
========================================================

Тестовый endpoint  
(оставлено без изменений)

Тестовые карты (таблица → JSON):

{
  "test_cards": {
    "success": {
      "number": "5555 5555 5555 4444",
      "expiry": "12/25",
      "cvv": "000"
    },
    "insufficient_funds": {
      "number": "5555 5555 5555 4642",
      "expiry": "12/25",
      "cvv": "000"
    }
  }
}


========================================================
Безопасность
========================================================

Рекомендации  
(оставлено без изменений)

--------------------------------------------------------
Обработка ошибок (таблица → JSON)
--------------------------------------------------------

{
  "http_codes": {
    "200": "Успешно",
    "400": "Некорректный запрос",
    "401": "Неверный токен",
    "404": "Подписка не найдена",
    "500": "Внутренняя ошибка"
  },
  "error_format_example": {
    "error": "Subscription not found"
  }
}


Причины неудачных списаний (таблица → JSON):

{
  "failure_reasons": [
    "Недостаточно средств",
    "Карта заблокирована",
    "Карта истекла",
    "Превышен лимит",
    "Проблемы банка"
  ]
}


========================================================
Ограничения (таблица → JSON)
========================================================

{
  "limits": {
    "currency": "RUB",
    "rate_limit": "100 запросов в минуту",
    "custom_data_max": "5KB",
    "webhook_timeout": "30 секунд",
    "retry_attempts": 3
  }
}
